# ==========================================
# Ã‰tape 1 : Build & tests (dev + CI)
# ==========================================
FROM node:20-alpine AS build

WORKDIR /app

# Copie des fichiers de dÃ©pendances
COPY package*.json ./

# DÃ©finition du contexte dâ€™environnement (test ou prod)
ARG NODE_ENV=production
ENV NODE_ENV=$NODE_ENV

# Installation des dÃ©pendances :
# â†’ Si NODE_ENV=test â†’ installe toutes les deps (incl. Jest)
# â†’ Sinon â†’ installe seulement les deps de prod
RUN if [ "$NODE_ENV" = "test" ]; then \
      echo "Installing all dependencies (for tests)..." && npm ci; \
    else \
      echo "Installing production dependencies only..." && npm ci --only=production; \
    fi

# Copie du code source complet
COPY . .

# Si en CI, exÃ©cuter les tests (ne bloque pas le build si Ã©chec mineur)
RUN if [ "$NODE_ENV" = "test" ]; then \
      echo "ðŸ§ª Running tests..." && npm test || echo ' Tests failed, continuing build'; \
    fi


# ==========================================
# Ã‰tape 2 : ExÃ©cution en production
# ==========================================
FROM node:20-alpine AS production

WORKDIR /app

# Copie uniquement les fichiers nÃ©cessaires depuis le build
COPY --from=build /app/node_modules ./node_modules
COPY --from=build /app/server.js ./server.js
COPY --from=build /app/app.js ./app.js
COPY --from=build /app/config ./config
COPY --from=build /app/models ./models
COPY --from=build /app/routes ./routes
COPY --from=build /app/utils ./utils
COPY --from=build /app/package*.json ./

# DÃ©finition des variables dâ€™environnement
ENV NODE_ENV=production
ENV PORT=8080

EXPOSE 8080

CMD ["node", "server.js"]
