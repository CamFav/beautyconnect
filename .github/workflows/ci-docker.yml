name: CI Tests (Docker)

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

jobs:
  test-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create backend .env file
        run: |
          echo "NODE_ENV=test" >> backend/.env
          echo "PORT=5001" >> backend/.env
          echo "JWT_SECRET=testsecret" >> backend/.env
          echo "MONGO_URL=mongodb://mongo:27017/beautyconnect_test" >> backend/.env
          echo "CLOUDINARY_URL=dummy" >> backend/.env

      - name: Safety check (prevent prod DB usage)
        run: |
          if grep -q "mongodb://mongo:27017/beautyconnect$" backend/.env; then
            echo "Refus d'utiliser la base de prod dans les tests !" && exit 1
          fi

      - name: Build containers
        run: docker compose build

      - name: Start backend & mongo
        env:
          NODE_ENV: test
          JWT_SECRET: testsecret
          MONGO_URL: mongodb://mongo:27017/beautyconnect_test
        run: docker compose up -d mongo backend

      - name: Run Jest tests in backend container
        env:
          NODE_ENV: test
          JWT_SECRET: testsecret
          MONGO_URL: mongodb://mongo:27017/beautyconnect_test
        run: |
          docker compose run --rm -e NODE_ENV=test -e JWT_SECRET=testsecret backend sh -c "cd /app && npm test"

      - name: Stop containers
        if: always()
        run: docker compose down
