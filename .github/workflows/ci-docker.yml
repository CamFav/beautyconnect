name: CI Tests (Docker)

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

jobs:
  test-backend:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # Checkout du dépôt
      # ------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------
      # Cache npm pour accélérer npm ci
      # ------------------------------
      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      # ------------------------------
      # Cache Docker layers (build backend)
      # ------------------------------
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: docker-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            docker-${{ runner.os }}-

      # ------------------------------
      # Génération du .env test
      # ------------------------------
      - name: Create backend .env file
        run: |
          echo "NODE_ENV=test" >> backend/.env
          echo "PORT=5001" >> backend/.env
          echo "JWT_SECRET=testsecret" >> backend/.env
          echo "MONGO_URL=mongodb://mongo:27017/beautyconnect_test" >> backend/.env
          echo "CLOUDINARY_URL=dummy" >> backend/.env

      - name: Safety check (prevent prod DB usage)
        run: |
          if grep -q "mongodb://mongo:27017/beautyconnect$" backend/.env; then
            echo "Refus d'utiliser la base de prod dans les tests !" && exit 1
          fi

      # ------------------------------
      # Build du backend avec Docker cache + Jest
      # ------------------------------
      - name: Build containers with test environment
        run: |
          docker compose build --build-arg NODE_ENV=test

      # ------------------------------
      # Lancement de Mongo + backend
      # ------------------------------
      - name: Start backend & mongo
        env:
          NODE_ENV: test
          JWT_SECRET: testsecret
          MONGO_URL: mongodb://mongo:27017/beautyconnect_test
        run: docker compose up -d mongo backend

        # ------------------------------
      # Exécution des tests Jest
      # ------------------------------
      - name: Run Jest tests in backend container
        env:
          NODE_ENV: test
          JWT_SECRET: testsecret
          MONGO_URL: mongodb://mongo:27017/beautyconnect_test
          DISABLE_MMS: 1 # force le disable de mongodb-memory-server
        run: |
          docker compose run --rm \
            -e NODE_ENV=test \
            -e JWT_SECRET=testsecret \
            -e MONGO_URL=mongodb://mongo:27017/beautyconnect_test \
            -e DISABLE_MMS=1 \
            backend sh -c "npm test -- --runInBand --coverage"
      # ------------------------------
      # Arrêt et nettoyage
      # ------------------------------
      - name: Stop containers
        if: always()
        run: docker compose down --volumes --remove-orphans

      - name: Cleanup Docker cache
        if: always()
        run: |
          docker system prune -af
