name: CI Tests (Docker)

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  test-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Build containers
        run: docker compose build

      - name: Start backend & mongo
        env:
          JWT_SECRET: testsecret
          MONGO_URL: mongodb://mongo:27017/beautyconnect-test
        run: docker compose up -d mongo backend

      - name: Run Jest tests in backend container
        env:
          JWT_SECRET: testsecret
          MONGO_URL: mongodb://mongo:27017/beautyconnect-test
          NODE_ENV: test
        run: docker compose exec -T backend sh -c "cd /app && npm test"

      - name: Stop containers
        if: always()
        run: docker compose down
