name: CI Tests (Docker)

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

jobs:
  test-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create backend .env file
        run: |
          echo "NODE_ENV=test" >> backend/.env
          echo "PORT=5001" >> backend/.env
          echo "JWT_SECRET=testsecret" >> backend/.env
          echo "MONGO_URL=mongodb://mongo:27017/beautyconnect_test" >> backend/.env
          echo "CLOUDINARY_URL=dummy" >> backend/.env

      - name: Safety check (prevent prod DB usage)
        run: |
          if grep -q "mongodb://mongo:27017/beautyconnect$" backend/.env; then
            echo "Refus d'utiliser la base de prod dans les tests !" && exit 1
          fi

      # Build des conteneurs avec les bons arguments pour Jest
      - name: Build containers with test environment
        run: docker compose build --build-arg NODE_ENV=test

      # Lancement Mongo + backend (test)
      - name: Start backend & mongo
        env:
          NODE_ENV: test
          JWT_SECRET: testsecret
          MONGO_URL: mongodb://mongo:27017/beautyconnect_test
        run: docker compose up -d mongo backend

      # Ex√©cution des tests Jest via le conteneur
      - name: Run Jest tests in backend container
        run: |
          docker compose run --rm \
            -e NODE_ENV=test \
            -e JWT_SECRET=testsecret \
            -e MONGO_URL=mongodb://mongo:27017/beautyconnect_test \
            backend sh -c "npm test -- --runInBand --coverage"

      - name: Stop containers
        if: always()
        run: docker compose down
